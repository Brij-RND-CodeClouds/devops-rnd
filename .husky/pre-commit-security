#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running security checks..."

# Check for sensitive files that might be accidentally staged
SENSITIVE_FILES=$(git diff --cached --name-only | grep -E '\.(pem|key|p12|pfx)$|firebase.*adminsdk.*\.json$|\.env$|\.env\..*$|service-account.*\.json$|private.*key|credentials\.json$' | grep -v '\.secrets-baseline$' || true)

if [ ! -z "$SENSITIVE_FILES" ]; then
    echo "‚ùå SECURITY WARNING: Sensitive files detected in staging area:"
    echo "$SENSITIVE_FILES"
    echo ""
    echo "Please review these files and ensure they should be committed."
    echo "If these are sensitive files, add them to .gitignore and unstage them:"
    echo "  git reset HEAD <filename>"
    echo ""
    exit 1
fi

# Check for hardcoded secrets in staged files (exclude documentation and examples)
echo "üîê Scanning for hardcoded secrets..."
SECRETS_FOUND=$(git diff --cached -- '*.ts' '*.tsx' '*.js' '*.jsx' '*.json' | grep -iE 'password\s*=|api[_-]?key\s*=|secret\s*=|token\s*=|private[_-]?key|AKIA[0-9A-Z]{16}|sk_live_|pk_live_' | grep -v '^[+-]#' | grep -v '^[+-]\s*\*' | grep -v '^[+-]\s*//' || true)

if [ ! -z "$SECRETS_FOUND" ]; then
    echo "‚ùå POTENTIAL SECRETS DETECTED in staged changes:"
    echo "$SECRETS_FOUND"
    echo ""
    echo "Please review and remove any hardcoded secrets before committing."
    echo "Consider using environment variables instead."
    echo ""
    exit 1
fi

# Check for large files (>5MB)
echo "üì¶ Checking for large files..."
LARGE_FILES=$(git diff --cached --name-only | xargs -I {} sh -c 'if [ -f "{}" ] && [ $(stat -f%z "{}" 2>/dev/null || stat -c%s "{}" 2>/dev/null || echo 0) -gt 5242880 ]; then echo "{}"; fi' || true)

if [ ! -z "$LARGE_FILES" ]; then
    echo "‚ö†Ô∏è  WARNING: Large files detected (>5MB):"
    echo "$LARGE_FILES"
    echo ""
    echo "Consider using Git LFS for large files or ensure these files are necessary."
    echo ""
fi

echo "‚úÖ Security checks passed!"